var tianliGPTIsRunning=!1,tianliGPTLastRunTime=0,tianliGPTIcon=`<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="48px" height="48px" viewBox="0 0 48 48">
    <g id="&#x673A;&#x5668;&#x4EBA;" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
      <path d="M34.717885,5.03561087 C36.12744,5.27055371 37.079755,6.60373651 36.84481,8.0132786 L35.7944,14.3153359 L38.375,14.3153359 C43.138415,14.3153359 47,18.1768855 47,22.9402569 L47,34.4401516 C47,39.203523 43.138415,43.0650727 38.375,43.0650727 L9.625,43.0650727 C4.861585,43.0650727 1,39.203523 1,34.4401516 L1,22.9402569 C1,18.1768855 4.861585,14.3153359 9.625,14.3153359 L12.2056,14.3153359 L11.15519,8.0132786 C10.920245,6.60373651 11.87256,5.27055371 13.282115,5.03561087 C14.69167,4.80066802 16.024865,5.7529743 16.25981,7.16251639 L17.40981,14.0624532 C17.423955,14.1470924 17.43373,14.2315017 17.43948,14.3153359 L30.56052,14.3153359 C30.56627,14.2313867 30.576045,14.1470924 30.59019,14.0624532 L31.74019,7.16251639 C31.975135,5.7529743 33.30833,4.80066802 34.717885,5.03561087 Z M38.375,19.4902885 L9.625,19.4902885 C7.719565,19.4902885 6.175,21.0348394 6.175,22.9402569 L6.175,34.4401516 C6.175,36.3455692 7.719565,37.89012 9.625,37.89012 L38.375,37.89012 C40.280435,37.89012 41.825,36.3455692 41.825,34.4401516 L41.825,22.9402569 C41.825,21.0348394 40.280435,19.4902885 38.375,19.4902885 Z M14.8575,23.802749 C16.28649,23.802749 17.445,24.9612484 17.445,26.3902253 L17.445,28.6902043 C17.445,30.1191812 16.28649,31.2776806 14.8575,31.2776806 C13.42851,31.2776806 12.27,30.1191812 12.27,28.6902043 L12.27,26.3902253 C12.27,24.9612484 13.42851,23.802749 14.8575,23.802749 Z M33.1425,23.802749 C34.57149,23.802749 35.73,24.9612484 35.73,26.3902253 L35.73,28.6902043 C35.73,30.1191812 34.57149,31.2776806 33.1425,31.2776806 C31.71351,31.2776806 30.555,30.1191812 30.555,28.6902043 L30.555,26.3902253 C30.555,24.9612484 31.71351,23.802749 33.1425,23.802749 Z" id="&#x5F62;&#x72B6;&#x7ED3;&#x5408;" fill-rule="nonzero"></path>
    </g>
    </svg>`,tianliGPTSystem="";function tianliGPT(e){function n(n,e){(t=document.querySelector(".post-TianliGPT"))&&t.parentElement.removeChild(t);let i=document.querySelector(n);e=e||n;var t=document.querySelector(e);if(!i){let e=0,t=setInterval(()=>{e+=300,(i=document.querySelector(n))?clearInterval(t):2e4<=e&&(clearInterval(t),console.log("超时未找到元素"))},300)}var e=document.createElement("div"),o=(e.className="post-TianliGPT","undefined"!=typeof tianliGPT_theme&&tianliGPT_theme&&e.classList.add("gpttheme_"+tianliGPT_theme.toLowerCase()),document.createElement("div")),a=(o.className="tianliGPT-title",e.appendChild(o),document.createElement("i")),a=(a.className="tianliGPT-title-icon",o.appendChild(a),a.innerHTML=tianliGPTIcon,document.createElement("div")),a=(a.className="tianliGPT-title-text","undefined"==typeof tianliGPT_Title?a.textContent="AI摘要":a.textContent=tianliGPT_Title,o.appendChild(a),document.createElement("div")),o=(a.className="tianliGPT-tag",a.id="tianliGPT-tag","undefined"==typeof tianliGPT_Name?a.textContent="TianliGPT":a.textContent=tianliGPT_Name,o.appendChild(a),document.createElement("div"));o.className="tianliGPT-explanation",o.innerHTML='生成中...<span class="blinking-cursor"></span>',e.appendChild(o),t?t.insertBefore(e,t.firstChild):i&&i.insertBefore(e,i.firstChild)}function T(){let t=["#thread_subject",".view_tit","h1",".postlist_top h2"];var e=(document.title||"").trim(),n=function(){for(var e of t){e=document.querySelector(e);if(e&&e.textContent.trim())return(e=(e=e).cloneNode(!0)).querySelectorAll("em").forEach(e=>e.remove()),e.textContent.trim()}return null}();return n&&e.startsWith(n)?n.trim():e}var d={discuz_getTitleAndContent:function(){try{var i,o=T(),a=document.querySelector(tianliGPT_postSelector),r=(a||(console.warn("TianliGPT：找不到文章容器。将在2秒后重新检查。"),setTimeout(()=>{document.querySelector(tianliGPT_postSelector)?(tianliGPTIsRunning=!1,m()):console.warn("TianliGPT：再次检查后仍找不到文章容器。如果本页面不打算展示摘要，可以忽略此提醒。请确保代码放置在正确的位置。")},500)),a.cloneNode(!0)),l=(r.querySelectorAll(".showhide, .locked, script, style, .authi, .post-TianliGPT, .code, .terminal_frame").forEach(e=>e.remove()),"Discuz"==tianliGPTSystem&&r.querySelectorAll(".txtlist.cl, .view_reply.cl, ignore_js_op, #hm_qrcode, .readthread_box",".smplayerbox",".it618_tieclick_ajax",".attach_nopermission").forEach(e=>e.remove()),r.querySelectorAll("p, strong, font, ul, li, ol, span, td")),s=r.querySelectorAll("h1, h2, h3, h4, h5");let t="";for(i of s)t+=i.innerText+" ";var c,u=[];for(c of l){var d=Array.from(c.childNodes).filter(e=>e.nodeType===Node.TEXT_NODE).map(e=>e.textContent).join("").trim().replace(/https?:\/\/[^\s]+/g,"");""!==d.trim()&&u.push(d)}if(0===u.length){let e=r.innerText;e=e.replace(/\n/g," ").replace(/\s+/g," ").trim(),t+=e}else t=u.join(" ");let e=o+" "+t.trim(),n=(e=e.replace(/(\s*\n\s*)+/g," ").trim(),1e3);return"undefined"!=typeof tianliGPT_wordLimit&&(n=tianliGPT_wordLimit),e.slice(0,n)}catch(e){return console.warn("TianliGPT错误：可能由于一个或多个情况在本页面没有正常运行，如果本不打算在此页面展示，可以忽略此提醒，原因出在获取文章容器中的内容失败，或者可能是在文章转换过程中失败。",e),""}},old_getTitleAndContent:function(){try{var n,i,o=document.title,a=document.querySelector(tianliGPT_postSelector),r=(a||(console.warn("TianliGPT：找不到文章容器。将在2秒后重新检查。"),setTimeout(()=>{document.querySelector(tianliGPT_postSelector)?(tianliGPTIsRunning=!1,m()):console.warn("TianliGPT：再次检查后仍找不到文章容器。如果本页面不打算展示摘要，可以忽略此提醒。请确保代码放置在正确的位置。")},500)),a.getElementsByTagName("p")),l=a.querySelectorAll("h1, h2, h3, h4, h5");let e="";for(n of l)e+=n.innerText+" ";for(i of r){var s=i.innerText.replace(/https?:\/\/[^\s]+/g,"");e+=s}var c=o+" "+e;let t=1e3;return"undefined"!=typeof tianliGPT_wordLimit&&(t=tianliGPT_wordLimit),c.slice(0,t)}catch(e){return console.warn("TianliGPT错误：可能由于一个或多个情况在本页面没有正常运行，如果本不打算在此页面展示，可以忽略此提醒，原因出在获取文章容器中的内容失败，或者可能是在文章转换过程中失败。",e),""}},fetchTianliGPT:async function(e){let t="";var n=document.querySelector("script[data-postChat_key]");if(n)t=n.getAttribute("data-postChat_key");else{if("undefined"==typeof tianliGPT_key)return d.aiShowAnimation(n="没有获取到key，代码可能没有安装正确。如果你需要在tianli_gpt文件引用前定义tianliGPT_key变量。详细请查看文档。"),n;t=tianliGPT_key}if("5Q5mpqRK5DkwT1X9Gi5e"===tianliGPT_key)return d.aiShowAnimation(n="请购买 key 使用，如果你能看到此条内容，则说明代码安装正确。"),n;var n=window.location.href,i=document.title;let o="https://summary.tianli0.top/",a=1e4;if("Discuz"===tianliGPTSystem){var r=new URL(n),l="undefined"!=typeof tianliGPT_discuz_tid?tianliGPT_discuz_tid:"undefined"!=typeof tid?tid:null;if(!l)return u="Discuz中需要携带tid参数，变量名为：tianliGPT_discuz_tid，例如：let tianliGPT_discuz_tid = '2'，当tid不存在的页面可以设为0。不允许不包含tid参数的Discuz请求。建议使用Discuz插件实现。",console.log(u),u;n=r.origin+"/forum.php?mod=viewthread&tid="+l}let s=JSON.stringify({content:e,key:t,url:n,title:i,system:tianliGPTSystem});async function c(){let e=new AbortController;var t=setTimeout(()=>e.abort(),a);try{var n=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:s,signal:e.signal});if(clearTimeout(t),n.ok)return{summary:(await n.json()).summary};{let e="";var i=await n.json();if(514===n.status)return e="TianliGPT is only available in mainland China, and is not yet open to overseas users, so stay tuned!",d.aiShowAnimation(e),e;if(403===n.status)switch(i.err_code){case 1:return e='你的网站设置了Referrer-Policy为same-origin，这会导致Tianli无法验证你的请求来源。TianliGPT依赖refer进行来源判断，特别是meta标签的referrer属性需要修改，至少为origin。例如：<meta name="referrer" content="origin">',d.aiShowAnimation(e),e;case 2:return e="你正在使用的账户Key或tianliGPT_key没有绑定当前网站，请检查当前的密钥是否绑定了当前网站地址。可以到summary.zhheo.com中绑定。",d.aiShowAnimation(e),e;case 3:return e="参数缺失，请检查是否正确配置账户Key或tianliGPT_key",d.aiShowAnimation(e),e;case 4:throw document.querySelectorAll(".post-TianliGPT").forEach(e=>{e.style.display="none"}),e="Key错误或余额不足，请充值后请求新的文章",new Error("TianliGPT："+e);case 5:throw document.querySelectorAll(".post-TianliGPT").forEach(e=>{e.style.display="none"}),e="未知错误",new Error("TianliGPT："+e);case 6:throw document.querySelectorAll(".post-TianliGPT").forEach(e=>{e.style.display="none"}),e="数据库错误",new Error("TianliGPT："+e);case 7:return e=i.err_msg,d.aiShowAnimation(e),e;default:return d.aiShowAnimation("未知错误，请检查API文档"),"未知错误，请检查API文档"}}}catch(e){return clearTimeout(t),"AbortError"===e.name?(console.warn("请求超时"),"timeout"):(console.error("请求失败：",e),"error")}}var u=await c();return"timeout"===u?(console.warn("第一次请求超时，尝试第二次请求..."),"timeout"===(r=await c())||"error"===r?(d.aiShowAnimation(l="目前生成摘要任务排队较多，请稍候刷新再试"),l):r):u},aiShowAnimation:function(i){let o=document.querySelector(".tianliGPT-explanation");if(!o)return;if(tianliGPTIsRunning)return;if(tianliGPTIsRunning=!0,"undefined"!=typeof tianliGPT_typingAnimate&&!tianliGPT_typingAnimate)return o.innerHTML=i,void(tianliGPTIsRunning=!1);let a=25;let r=6,l=(o.style.display="block",o.innerHTML='生成中...<span class="blinking-cursor"></span>',document.querySelector(".tianliGPT-tag").classList.add("loadingAI"),!0),s=0,c=performance.now(),u=()=>{var e,t,n;s<i.length&&l&&(t=(e=performance.now())-c,n=i.slice(s,s+1),(/[，。！、？,.!?]/.test(n)?a*r:a)<=t&&(o.innerText=i.slice(0,s+1),c=e,++s<i.length?o.innerHTML=i.slice(0,s)+'<span class="blinking-cursor"></span>':(o.innerHTML=i,o.style.display="block",tianliGPTIsRunning=!1,d.disconnect(),document.querySelector(".tianliGPT-tag").classList.remove("loadingAI"))),requestAnimationFrame(u))},d=new IntersectionObserver(e=>{e=e[0].isIntersecting;(l=e)&&setTimeout(()=>{requestAnimationFrame(u)},200)},{threshold:0});var e=document.querySelector(".post-TianliGPT");d.observe(e)}};function i(){if("undefined"!=typeof tianliGPT_postSelector){if("Discuz"===tianliGPTSystem){var t=document.querySelector(tianliGPT_postSelector);if(t)if(t.querySelector('a[href*="plugin.php?id=duceapp_vip&ac=pay&referer=forum.php"]'))return}n(tianliGPT_postSelector,"undefined"!=typeof tianliGPT_injectDom?tianliGPT_injectDom:null);let e;(e="Discuz"===tianliGPTSystem?d.discuz_getTitleAndContent():d.old_getTitleAndContent())&&console.log("TianliGPT本次提交的内容为："+e),"https:"!==window.location.protocol?d.aiShowAnimation("为了保证传输的安全性和可靠性，不支持在http协议下显示文章摘要。请为网站申请证书，并在summary.zhheo.com使用https协议的地址绑定即可。如果是本地或者局域网访问，可以忽略此警告。"):d.fetchTianliGPT(e).then(e=>{let t=e.summary,n;"undefined"!=typeof tianliGPT_BeginningText?n=tianliGPT_BeginningText:"undefined"!=typeof postChatConfig&&postChatConfig.beginningText?n=postChatConfig.beginningText:"Discuz"===tianliGPTSystem&&(n="这个帖子"),n&&(t.match(/^这篇文章[\u4e00-\u9fa5]{1,2}了/)?t=t.replace(/^这篇文章[\u4e00-\u9fa5]{1,2}了/g,""+n):t.match(/^这篇文章通过/)&&(t=t.replace(/^这篇文章通过/g,n+"通过"))),t=t.replace(/介绍了通过/g,"通过"),d.aiShowAnimation(t)})}}function m(){var e=Date.now();if(!(e-tianliGPTLastRunTime<500)){tianliGPTLastRunTime=e;e=document.querySelector('meta[name="generator"]');if(e&&e.content.includes("WordPress")){e=new URL(window.location.href);if(e.searchParams.has("preview")&&"true"===e.searchParams.get("preview"))return void console.log("当前页面为WordPress预览模式，不执行摘要功能。")}if("undefined"==typeof tianliGPT_postURL)o();else try{let e;e=(e=>{try{return new RegExp(e),e.startsWith("/")&&e.endsWith("/")&&2<e.length}catch(e){return!1}})(tianliGPT_postURL)?new RegExp(tianliGPT_postURL.slice(1,-1)):(e=>{e=e.replace(/[|\\{}()[\]^$+?.]/g,"\\$&");return new RegExp("^"+e.split(/\*+/).join(".*")+"$")})(tianliGPT_postURL);var t=window.location.href;e.test(t)?o():console.log(`TianliGPT：当前 URL '${t}' 不符合规则 '${tianliGPT_postURL}'，所以我决定不执行摘要功能。`)}catch(e){console.error("TianliGPT：我没有看懂你编写的自定义链接规则，所以我决定不执行摘要功能",e)}}}function o(){let t=0,n=setInterval(()=>{try{"undefined"!=typeof tianliGPT_blacklist&&tianliGPT_blacklist?fetch(tianliGPT_blacklist).then(e=>e.json()).then(e=>{e=e.blackurls;let t=window.location.href;e.some(e=>{return new RegExp("^"+e.replace(/\*/g,".*")+"$").test(t)})||i()}).catch(e=>{console.error("请求黑名单失败。Error fetching blacklist:",e),i()}):i(),clearInterval(n)}catch(e){20<=t&&(clearInterval(n),console.error("TianliGPT：超时失败，停止尝试。",e)),t++}},200)}e?(postchat_checkSystemType(),m()):document.addEventListener("DOMContentLoaded",function(){postchat_checkSystemType(),m()})}function postchat_checkSystemType(){var e;"undefined"!=typeof postChatConfig&&postChatConfig.systemType?tianliGPTSystem=postChatConfig.systemType:(e=document.querySelector('meta[name="generator"]'))&&e.content.includes("Discuz")&&(tianliGPTSystem="Discuz")}postchat_checkSystemType(),tianliGPT(!1),document.addEventListener("pjax:complete",function(){console.log("pjax:complete"),postchat_checkSystemType(),tianliGPT(!0)}),document.addEventListener("pjax:success",function(){console.log("pjax:success"),tianliGPTIsRunning=!1}),function(n){var e=n.pushState;n.pushState=function(t){if("function"==typeof n.onpushstate)if("undefined"!=typeof pjaxLoading){let e=()=>{pjaxLoading?setTimeout(e,50):n.onpushstate({state:t})};e()}else setTimeout(function(){n.onpushstate({state:t})},200);return e.apply(n,arguments)}}(window.history),window.history.onpushstate=function(e){postchat_checkSystemType(),tianliGPT(!0)};
